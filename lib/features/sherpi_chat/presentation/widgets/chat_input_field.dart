import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:google_fonts/google_fonts.dart';

// Core
import '../../../../core/constants/app_colors.dart';

/// ‚å®Ô∏è Ï±ÑÌåÖ ÏûÖÎ†•Ï∞Ω ÏúÑÏ†Ø
/// 
/// ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÖ∞Î•¥ÌîºÏóêÍ≤å Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï† Ïàò ÏûàÎäî ÏûÖÎ†•Ï∞ΩÍ≥º Ï†ÑÏÜ° Î≤ÑÌäº
class ChatInputField extends StatefulWidget {
  final Function(String) onSendMessage;
  final bool isEnabled;
  final bool isLoading;
  final String? placeholder;
  final int maxLines;
  final List<String>? suggestions;

  const ChatInputField({
    super.key,
    required this.onSendMessage,
    this.isEnabled = true,
    this.isLoading = false,
    this.placeholder,
    this.maxLines = 4,
    this.suggestions,
  });

  @override
  State<ChatInputField> createState() => _ChatInputFieldState();
}

class _ChatInputFieldState extends State<ChatInputField>
    with TickerProviderStateMixin {
  final TextEditingController _textController = TextEditingController();
  final FocusNode _focusNode = FocusNode();
  late AnimationController _buttonAnimationController;
  late AnimationController _suggestionsAnimationController;
  
  bool _showSuggestions = false;
  bool _hasText = false;

  @override
  void initState() {
    super.initState();
    
    _buttonAnimationController = AnimationController(
      duration: const Duration(milliseconds: 200),
      vsync: this,
    );
    
    _suggestionsAnimationController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    
    _textController.addListener(_onTextChanged);
    _focusNode.addListener(_onFocusChanged);
  }

  @override
  void dispose() {
    _textController.dispose();
    _focusNode.dispose();
    _buttonAnimationController.dispose();
    _suggestionsAnimationController.dispose();
    super.dispose();
  }

  void _onTextChanged() {
    final hasText = _textController.text.trim().isNotEmpty;
    if (hasText != _hasText) {
      setState(() {
        _hasText = hasText;
      });
      
      if (hasText) {
        _buttonAnimationController.forward();
      } else {
        _buttonAnimationController.reverse();
      }
    }
  }

  void _onFocusChanged() {
    if (_focusNode.hasFocus && widget.suggestions != null && widget.suggestions!.isNotEmpty) {
      setState(() {
        _showSuggestions = true;
      });
      _suggestionsAnimationController.forward();
    } else {
      setState(() {
        _showSuggestions = false;
      });
      _suggestionsAnimationController.reverse();
    }
  }

  void _sendMessage() {
    final text = _textController.text.trim();
    if (text.isNotEmpty && widget.isEnabled && !widget.isLoading) {
      widget.onSendMessage(text);
      _textController.clear();
      
      // ÌñÖÌã± ÌîºÎìúÎ∞±
      HapticFeedback.lightImpact();
      
      // Ìè¨Ïª§Ïä§ Ïú†ÏßÄ (Ïó∞ÏÜç ÎåÄÌôîÎ•º ÏúÑÌï¥)
      _focusNode.requestFocus();
    }
  }

  void _selectSuggestion(String suggestion) {
    _textController.text = suggestion;
    _textController.selection = TextSelection.fromPosition(
      TextPosition(offset: suggestion.length),
    );
    setState(() {
      _showSuggestions = false;
    });
    _suggestionsAnimationController.reverse();
    _focusNode.requestFocus();
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      mainAxisSize: MainAxisSize.min,
      children: [
        // Ï†úÏïà Î™©Î°ù
        if (_showSuggestions && widget.suggestions != null)
          _buildSuggestions(),
        
        // ÏûÖÎ†•Ï∞Ω ÏòÅÏó≠
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: Colors.white,
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.05),
                blurRadius: 10,
                offset: const Offset(0, -2),
              ),
            ],
          ),
          child: SafeArea(
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                // ÏûÖÎ†•Ï∞Ω
                Expanded(
                  child: Container(
                    constraints: BoxConstraints(
                      minHeight: 48,
                      maxHeight: widget.maxLines * 24.0 + 24,
                    ),
                    decoration: BoxDecoration(
                      color: Colors.grey.shade50,
                      borderRadius: BorderRadius.circular(24),
                      border: Border.all(
                        color: _focusNode.hasFocus 
                            ? AppColors.primary.withOpacity(0.5)
                            : Colors.grey.shade200,
                      ),
                    ),
                    child: TextField(
                      controller: _textController,
                      focusNode: _focusNode,
                      enabled: widget.isEnabled && !widget.isLoading,
                      maxLines: null,
                      textInputAction: TextInputAction.send,
                      onSubmitted: (_) => _sendMessage(),
                      style: GoogleFonts.notoSans(
                        fontSize: 15,
                        color: AppColors.textPrimary,
                      ),
                      decoration: InputDecoration(
                        hintText: widget.placeholder ?? 'ÏÖ∞Î•¥ÌîºÏóêÍ≤å ÎßêÌï¥Î≥¥ÏÑ∏Ïöî...',
                        hintStyle: GoogleFonts.notoSans(
                          fontSize: 15,
                          color: Colors.grey.shade500,
                        ),
                        border: InputBorder.none,
                        contentPadding: const EdgeInsets.symmetric(
                          horizontal: 20,
                          vertical: 14,
                        ),
                        // Î°úÎî© Ï§ëÏùº Îïå ÌëúÏãú
                        suffixIcon: widget.isLoading 
                            ? Padding(
                                padding: const EdgeInsets.all(12),
                                child: SizedBox(
                                  width: 20,
                                  height: 20,
                                  child: CircularProgressIndicator(
                                    strokeWidth: 2,
                                    valueColor: AlwaysStoppedAnimation<Color>(
                                      AppColors.primary,
                                    ),
                                  ),
                                ),
                              )
                            : null,
                      ),
                    ),
                  ),
                ),
                
                const SizedBox(width: 12),
                
                // Ï†ÑÏÜ° Î≤ÑÌäº
                AnimatedBuilder(
                  animation: _buttonAnimationController,
                  builder: (context, child) {
                    return Transform.scale(
                      scale: 0.8 + (_buttonAnimationController.value * 0.2),
                      child: Container(
                        width: 48,
                        height: 48,
                        decoration: BoxDecoration(
                          color: _hasText && widget.isEnabled && !widget.isLoading
                              ? AppColors.primary
                              : Colors.grey.shade300,
                          shape: BoxShape.circle,
                          boxShadow: _hasText && widget.isEnabled && !widget.isLoading ? [
                            BoxShadow(
                              color: AppColors.primary.withOpacity(0.3),
                              blurRadius: 8,
                              offset: const Offset(0, 2),
                            ),
                          ] : [],
                        ),
                        child: Material(
                          color: Colors.transparent,
                          child: InkWell(
                            borderRadius: BorderRadius.circular(24),
                            onTap: _hasText && widget.isEnabled && !widget.isLoading 
                                ? _sendMessage 
                                : null,
                            child: Icon(
                              Icons.send_rounded,
                              color: _hasText && widget.isEnabled && !widget.isLoading
                                  ? Colors.white
                                  : Colors.grey.shade500,
                              size: 20,
                            ),
                          ),
                        ),
                      ),
                    );
                  },
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }

  /// üí° Ï†úÏïà Î™©Î°ù ÏúÑÏ†Ø
  Widget _buildSuggestions() {
    return AnimatedBuilder(
      animation: _suggestionsAnimationController,
      builder: (context, child) {
        return Transform.translate(
          offset: Offset(0, 20 * (1 - _suggestionsAnimationController.value)),
          child: Opacity(
            opacity: _suggestionsAnimationController.value,
            child: Container(
              constraints: const BoxConstraints(maxHeight: 120),
              margin: const EdgeInsets.symmetric(horizontal: 16),
              padding: const EdgeInsets.symmetric(vertical: 8),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: const BorderRadius.only(
                  topLeft: Radius.circular(16),
                  topRight: Radius.circular(16),
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.05),
                    blurRadius: 10,
                    offset: const Offset(0, -2),
                  ),
                ],
              ),
              child: ListView.builder(
                shrinkWrap: true,
                itemCount: widget.suggestions!.length,
                itemBuilder: (context, index) {
                  final suggestion = widget.suggestions![index];
                  return Material(
                    color: Colors.transparent,
                    child: InkWell(
                      onTap: () => _selectSuggestion(suggestion),
                      borderRadius: BorderRadius.circular(8),
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                          horizontal: 16,
                          vertical: 12,
                        ),
                        child: Row(
                          children: [
                            Icon(
                              Icons.lightbulb_outline,
                              size: 16,
                              color: AppColors.primary,
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Text(
                                suggestion,
                                style: GoogleFonts.notoSans(
                                  fontSize: 14,
                                  color: AppColors.textPrimary,
                                  fontWeight: FontWeight.w400,
                                ),
                                maxLines: 1,
                                overflow: TextOverflow.ellipsis,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
        );
      },
    );
  }
}

/// üéØ Ï±ÑÌåÖ Ï†úÏïà ÎèÑÏö∞ÎØ∏ ÌÅ¥ÎûòÏä§
class ChatSuggestionHelper {
  /// ÏùºÎ∞òÏ†ÅÏù∏ ÎåÄÌôî ÏãúÏûë Ï†úÏïàÎì§
  static const List<String> generalSuggestions = [
    'Ïò§Îäò ÌïòÎ£®Îäî Ïñ¥Îï†Ïñ¥?',
    'ÏöîÏ¶ò Í∏∞Î∂ÑÏù¥ Ïñ¥Îïå?',
    'ÏÉàÎ°úÏö¥ Î™©ÌëúÎ•º ÏÑ∏Ïö∞Í≥† Ïã∂Ïñ¥',
    'Ï°∞Ïñ∏Ïù¥ ÌïÑÏöîÌï¥',
    'Í≤©Î†§Ìï¥Ï§ò',
    'Ìï®Íªò Í≥ÑÌöçÏùÑ ÏÑ∏ÏõåÎ≥¥Ïûê',
  ];

  /// Ï∂ïÌïò ÏÉÅÌô© Ï†úÏïàÎì§
  static const List<String> celebrationSuggestions = [
    'Î™©ÌëúÎ•º Îã¨ÏÑ±ÌñàÏñ¥!',
    'Ïò§Îäò Ï†ïÎßê ÎøåÎìØÌïú ÏùºÏù¥ ÏûàÏóàÏñ¥',
    'ÎìúÎîîÏñ¥ Ìï¥ÎÉàÏñ¥!',
    'ÏÑ±Ï∑®Í∞êÏù¥ ÎäêÍª¥Ï†∏',
  ];

  /// Í≤©Î†§Í∞Ä ÌïÑÏöîÌïú ÏÉÅÌô© Ï†úÏïàÎì§
  static const List<String> encouragementSuggestions = [
    'ÏöîÏ¶ò ÌûòÎì§Ïñ¥',
    'Ìè¨Í∏∞ÌïòÍ≥† Ïã∂Ïñ¥',
    'Îã§Ïãú ÏãúÏûëÌïòÍ≥† Ïã∂Ïñ¥',
    'Ïö©Í∏∞Í∞Ä ÌïÑÏöîÌï¥',
    'ÏúÑÎ°úÌï¥Ï§ò',
  ];

  /// Í≥ÑÌöç Í¥ÄÎ†® Ï†úÏïàÎì§
  static const List<String> planningSuggestions = [
    'ÏÉàÎ°úÏö¥ Î™©ÌëúÎ•º ÏÑ∏Ïö∞Í≥† Ïã∂Ïñ¥',
    'Í≥ÑÌöçÏùÑ Ïñ¥ÎñªÍ≤å ÏÑ∏Ïö∏Íπå?',
    'ÏäµÍ¥ÄÏùÑ ÎßåÎì§Í≥† Ïã∂Ïñ¥',
    'ÏãúÍ∞Ñ Í¥ÄÎ¶¨Í∞Ä Ïñ¥Î†§Ïõå',
  ];

  /// Ïª®ÌÖçÏä§Ìä∏Ïóê ÎßûÎäî Ï†úÏïà Î∞òÌôò
  static List<String> getSuggestionsForContext(String context) {
    switch (context.toLowerCase()) {
      case 'celebration':
        return celebrationSuggestions;
      case 'encouragement':
        return encouragementSuggestions;
      case 'planning':
        return planningSuggestions;
      default:
        return generalSuggestions;
    }
  }
}