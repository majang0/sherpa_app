// lib/features/meetings/presentation/widgets/meeting_creation_steps/quick_datetime_picker.dart

import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:flutter_animate/flutter_animate.dart';
import '../../../../../core/constants/app_colors.dart';

/// üìÖ Îπ†Î•∏ ÎÇ†Ïßú/ÏãúÍ∞Ñ ÏÑ†ÌÉù - Step 3
/// ÏßÅÍ¥ÄÏ†ÅÏù∏ Ï∫òÎ¶∞ÎçîÏôÄ ÏãúÍ∞Ñ ÏÑ†ÌÉù UI
class QuickDateTimePicker extends StatefulWidget {
  final DateTime? selectedDateTime;
  final Function(DateTime) onDateTimeSelected;

  const QuickDateTimePicker({
    super.key,
    required this.selectedDateTime,
    required this.onDateTimeSelected,
  });

  @override
  State<QuickDateTimePicker> createState() => _QuickDateTimePickerState();
}

class _QuickDateTimePickerState extends State<QuickDateTimePicker> {
  DateTime selectedDate = DateTime.now().add(const Duration(days: 1));
  TimeOfDay selectedTime = TimeOfDay(hour: 14, minute: 0);
  
  // Îπ†Î•∏ ÏÑ†ÌÉù ÏòµÏÖò
  final List<Map<String, dynamic>> quickOptions = [
    {
      'label': 'ÎÇ¥Ïùº Ïò§ÌõÑ 2Ïãú',
      'date': DateTime.now().add(const Duration(days: 1)),
      'time': const TimeOfDay(hour: 14, minute: 0),
    },
    {
      'label': 'Ïù¥Î≤à Ï£ºÎßê Ïò§Ï†Ñ 10Ïãú',
      'date': DateTime.now().add(Duration(
        days: 6 - DateTime.now().weekday,
      )),
      'time': const TimeOfDay(hour: 10, minute: 0),
    },
    {
      'label': 'Îã§Ïùå Ï£º ÏõîÏöîÏùº Ïò§ÌõÑ 7Ïãú',
      'date': DateTime.now().add(Duration(
        days: 8 - DateTime.now().weekday,
      )),
      'time': const TimeOfDay(hour: 19, minute: 0),
    },
  ];

  @override
  void initState() {
    super.initState();
    if (widget.selectedDateTime != null) {
      selectedDate = widget.selectedDateTime!;
      selectedTime = TimeOfDay.fromDateTime(widget.selectedDateTime!);
    }
  }

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // ÏÑ§Î™Ö ÌÖçÏä§Ìä∏
          Text(
            'Î™®ÏûÑ ÎÇ†ÏßúÏôÄ ÏãúÍ∞ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî',
            style: GoogleFonts.notoSans(
              fontSize: 14,
              color: AppColors.textSecondary,
            ),
          ),
          
          const SizedBox(height: 24),
          
          // Îπ†Î•∏ ÏÑ†ÌÉù ÏòµÏÖò
          _buildQuickOptions()
            .animate()
            .fadeIn(duration: 300.ms)
            .slideY(begin: 0.1, end: 0, duration: 200.ms),
          
          const SizedBox(height: 32),
          
          // Íµ¨Î∂ÑÏÑ†
          Row(
            children: [
              Expanded(child: Divider(color: Colors.grey.shade300)),
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                child: Text(
                  'ÎòêÎäî ÏßÅÏ†ë ÏÑ†ÌÉù',
                  style: GoogleFonts.notoSans(
                    fontSize: 12,
                    color: AppColors.textSecondary,
                  ),
                ),
              ),
              Expanded(child: Divider(color: Colors.grey.shade300)),
            ],
          ),
          
          const SizedBox(height: 32),
          
          // ÎÇ†Ïßú ÏÑ†ÌÉù
          _buildDateSelector()
            .animate()
            .fadeIn(delay: 100.ms, duration: 300.ms)
            .slideY(begin: 0.1, end: 0, duration: 200.ms),
          
          const SizedBox(height: 24),
          
          // ÏãúÍ∞Ñ ÏÑ†ÌÉù
          _buildTimeSelector()
            .animate()
            .fadeIn(delay: 200.ms, duration: 300.ms)
            .slideY(begin: 0.1, end: 0, duration: 200.ms),
          
          const SizedBox(height: 32),
          
          // ÏÑ†ÌÉùÎêú ÎÇ†Ïßú/ÏãúÍ∞Ñ ÎØ∏Î¶¨Î≥¥Í∏∞
          _buildPreview()
            .animate()
            .fadeIn(delay: 300.ms, duration: 300.ms)
            .slideY(begin: 0.1, end: 0, duration: 200.ms),
        ],
      ),
    );
  }

  /// ‚ö° Îπ†Î•∏ ÏÑ†ÌÉù ÏòµÏÖò
  Widget _buildQuickOptions() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Îπ†Î•∏ ÏÑ†ÌÉù',
          style: GoogleFonts.notoSans(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 12),
        
        ...quickOptions.asMap().entries.map((entry) {
          final index = entry.key;
          final option = entry.value;
          
          return Container(
            width: double.infinity,
            margin: const EdgeInsets.only(bottom: 8),
            child: Material(
              color: Colors.transparent,
              child: InkWell(
                onTap: () {
                  final dateTime = DateTime(
                    option['date'].year,
                    option['date'].month,
                    option['date'].day,
                    option['time'].hour,
                    option['time'].minute,
                  );
                  
                  setState(() {
                    selectedDate = option['date'];
                    selectedTime = option['time'];
                  });
                  
                  widget.onDateTimeSelected(dateTime);
                },
                borderRadius: BorderRadius.circular(12),
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.grey.shade50,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: Colors.grey.shade200),
                  ),
                  child: Row(
                    children: [
                      Container(
                        width: 40,
                        height: 40,
                        decoration: BoxDecoration(
                          color: AppColors.primary.withOpacity(0.1),
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          Icons.schedule_rounded,
                          color: AppColors.primary,
                          size: 20,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Text(
                          option['label'],
                          style: GoogleFonts.notoSans(
                            fontSize: 16,
                            fontWeight: FontWeight.w600,
                            color: AppColors.textPrimary,
                          ),
                        ),
                      ),
                      Icon(
                        Icons.arrow_forward_ios_rounded,
                        color: AppColors.textSecondary,
                        size: 16,
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ).animate()
            .fadeIn(
              delay: Duration(milliseconds: 100 * index),
              duration: 300.ms,
            )
            .slideX(
              begin: 0.1,
              end: 0,
              delay: Duration(milliseconds: 100 * index),
              duration: 200.ms,
            );
        }).toList(),
      ],
    );
  }

  /// üìÖ ÎÇ†Ïßú ÏÑ†ÌÉù
  Widget _buildDateSelector() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'ÎÇ†Ïßú',
          style: GoogleFonts.notoSans(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 12),
        
        Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: _showDatePicker,
            borderRadius: BorderRadius.circular(12),
            child: Container(
              width: double.infinity,
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.grey.shade50,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Colors.grey.shade200),
              ),
              child: Row(
                children: [
                  Icon(
                    Icons.calendar_today_rounded,
                    color: AppColors.primary,
                    size: 20,
                  ),
                  const SizedBox(width: 12),
                  Text(
                    _formatDate(selectedDate),
                    style: GoogleFonts.notoSans(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                      color: AppColors.textPrimary,
                    ),
                  ),
                  const Spacer(),
                  Icon(
                    Icons.arrow_drop_down_rounded,
                    color: AppColors.textSecondary,
                  ),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }

  /// ‚è∞ ÏãúÍ∞Ñ ÏÑ†ÌÉù
  Widget _buildTimeSelector() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'ÏãúÍ∞Ñ',
          style: GoogleFonts.notoSans(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 12),
        
        // Ïù∏Í∏∞ ÏãúÍ∞ÑÎåÄ Î≤ÑÌäºÎì§
        SingleChildScrollView(
          scrollDirection: Axis.horizontal,
          child: Row(
            children: [
              _buildTimeChip('Ïò§Ï†Ñ 10:00', const TimeOfDay(hour: 10, minute: 0)),
              _buildTimeChip('Ïò§ÌõÑ 2:00', const TimeOfDay(hour: 14, minute: 0)),
              _buildTimeChip('Ïò§ÌõÑ 6:00', const TimeOfDay(hour: 18, minute: 0)),
              _buildTimeChip('Ïò§ÌõÑ 7:00', const TimeOfDay(hour: 19, minute: 0)),
              _buildTimeChip('ÏßÅÏ†ë ÏÑ†ÌÉù', null),
            ],
          ),
        ),
      ],
    );
  }

  /// ‚è∞ ÏãúÍ∞Ñ Ïπ©
  Widget _buildTimeChip(String label, TimeOfDay? time) {
    final isSelected = time != null && 
        selectedTime.hour == time.hour && 
        selectedTime.minute == time.minute;
    final isCustom = time == null;
    
    return Container(
      margin: const EdgeInsets.only(right: 8),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: () {
            if (isCustom) {
              _showTimePicker();
            } else {
              setState(() => selectedTime = time!);
              _updateDateTime();
            }
          },
          borderRadius: BorderRadius.circular(20),
          child: Container(
            padding: const EdgeInsets.symmetric(
              horizontal: 16,
              vertical: 10,
            ),
            decoration: BoxDecoration(
              color: isSelected || isCustom
                ? AppColors.primary
                : Colors.grey.shade100,
              borderRadius: BorderRadius.circular(20),
              border: Border.all(
                color: isSelected || isCustom
                  ? AppColors.primary
                  : Colors.grey.shade300,
              ),
            ),
            child: Text(
              isCustom ? label : label,
              style: GoogleFonts.notoSans(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: isSelected || isCustom
                  ? Colors.white
                  : AppColors.textSecondary,
              ),
            ),
          ),
        ),
      ),
    );
  }

  /// üëÄ ÎØ∏Î¶¨Î≥¥Í∏∞
  Widget _buildPreview() {
    final dateTime = DateTime(
      selectedDate.year,
      selectedDate.month,
      selectedDate.day,
      selectedTime.hour,
      selectedTime.minute,
    );
    
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            AppColors.primary.withOpacity(0.1),
            AppColors.secondary.withOpacity(0.1),
          ],
        ),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: AppColors.primary.withOpacity(0.2),
        ),
      ),
      child: Column(
        children: [
          Row(
            children: [
              Container(
                width: 48,
                height: 48,
                decoration: BoxDecoration(
                  color: AppColors.primary,
                  shape: BoxShape.circle,
                ),
                child: Icon(
                  Icons.event_available_rounded,
                  color: Colors.white,
                  size: 24,
                ),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Î™®ÏûÑ ÏùºÏ†ï',
                      style: GoogleFonts.notoSans(
                        fontSize: 12,
                        color: AppColors.textSecondary,
                      ),
                    ),
                    Text(
                      '${_formatDate(selectedDate)} ${_formatTime(selectedTime)}',
                      style: GoogleFonts.notoSans(
                        fontSize: 18,
                        fontWeight: FontWeight.w700,
                        color: AppColors.textPrimary,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          
          const SizedBox(height: 16),
          
          // ÌôïÏù∏ Î≤ÑÌäº
          SizedBox(
            width: double.infinity,
            child: ElevatedButton(
              onPressed: () => widget.onDateTimeSelected(dateTime),
              style: ElevatedButton.styleFrom(
                backgroundColor: AppColors.primary,
                padding: const EdgeInsets.symmetric(vertical: 16),
                elevation: 0,
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(12),
                ),
              ),
              child: Text(
                'Ïù¥ ÏãúÍ∞ÑÏúºÎ°ú ÌôïÏ†ï',
                style: GoogleFonts.notoSans(
                  fontSize: 16,
                  fontWeight: FontWeight.w700,
                  color: Colors.white,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  /// üìÖ ÎÇ†Ïßú ÏÑ†ÌÉù Îã§Ïù¥ÏñºÎ°úÍ∑∏
  void _showDatePicker() async {
    final date = await showDatePicker(
      context: context,
      initialDate: selectedDate,
      firstDate: DateTime.now(),
      lastDate: DateTime.now().add(const Duration(days: 365)),
      locale: const Locale('ko', 'KR'),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: Theme.of(context).colorScheme.copyWith(
              primary: AppColors.primary,
              onPrimary: Colors.white,
            ),
          ),
          child: child!,
        );
      },
    );
    
    if (date != null) {
      setState(() => selectedDate = date);
      _updateDateTime();
    }
  }

  /// ‚è∞ ÏãúÍ∞Ñ ÏÑ†ÌÉù Îã§Ïù¥ÏñºÎ°úÍ∑∏
  void _showTimePicker() async {
    final time = await showTimePicker(
      context: context,
      initialTime: selectedTime,
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: Theme.of(context).colorScheme.copyWith(
              primary: AppColors.primary,
              onPrimary: Colors.white,
            ),
          ),
          child: child!,
        );
      },
    );
    
    if (time != null) {
      setState(() => selectedTime = time);
      _updateDateTime();
    }
  }

  /// üìÖ ÎÇ†Ïßú Ìè¨Îß∑
  String _formatDate(DateTime date) {
    final weekdays = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'];
    final weekday = weekdays[date.weekday - 1];
    
    final now = DateTime.now();
    final daysDiff = DateTime(date.year, date.month, date.day)
        .difference(DateTime(now.year, now.month, now.day))
        .inDays;
    
    if (daysDiff == 0) {
      return 'Ïò§Îäò ($weekday)';
    } else if (daysDiff == 1) {
      return 'ÎÇ¥Ïùº ($weekday)';
    } else if (daysDiff == 2) {
      return 'Î™®Î†à ($weekday)';
    } else {
      return '${date.month}Ïõî ${date.day}Ïùº ($weekday)';
    }
  }

  /// ‚è∞ ÏãúÍ∞Ñ Ìè¨Îß∑
  String _formatTime(TimeOfDay time) {
    final period = time.hour < 12 ? 'Ïò§Ï†Ñ' : 'Ïò§ÌõÑ';
    final hour = time.hour > 12 ? time.hour - 12 : time.hour;
    final hourStr = hour == 0 ? 12 : hour;
    final minuteStr = time.minute.toString().padLeft(2, '0');
    
    return '$period ${hourStr}:${minuteStr}';
  }

  /// üîÑ ÎÇ†Ïßú/ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
  void _updateDateTime() {
    final dateTime = DateTime(
      selectedDate.year,
      selectedDate.month,
      selectedDate.day,
      selectedTime.hour,
      selectedTime.minute,
    );
    
    // ÏûêÎèôÏúºÎ°ú Îã§Ïùå Îã®Í≥ÑÎ°ú ÎÑòÏñ¥Í∞ÄÏßÄ ÏïäÍ≥† ÎØ∏Î¶¨Î≥¥Í∏∞Îßå ÏóÖÎç∞Ïù¥Ìä∏
    setState(() {});
  }
}